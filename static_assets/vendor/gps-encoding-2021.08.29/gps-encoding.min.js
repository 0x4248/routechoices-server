var intValCodec=function(){var t=function(t,i){for(var e=t.length,r=0,o=0,s=0,a=32;a>=32&&r+i<e;){if(a=t.charCodeAt(r+i)-63,r+=1,30===o)return n(t,i);s|=(31&a)<<o,o+=5}return[s,r]},i=function(i,n){var e=t(i,n);if(e[2]){var r=new BN(e[0],10);return"1"===r.and(new BN(1,10)).toString()?[parseInt(r.shrn(1).add(new BN(1)).neg().toString(),10),e[1],]:[parseInt(r.shrn(1).toString(),10),e[1],!0]}var r=e[0];return 1&r?[~(r>>>1),e[1]]:[r>>>1,e[1]]},n=function(t,i){for(var n=t.length,e=0,r=0,o=new BN(0,10),s=32;s>=32&&e+i<n;)s=t.charCodeAt(e+i)-63,e+=1,o=o.or(new BN(31&s,10).shln(r)),r+=5;return[parseInt(o.toString(),10),e,!0]};return{decodeUnsignedValueFromString:t,decodeSignedValueFromString:i}}(),Coordinates=function(t){if(!(this instanceof Coordinates))return new Coordinates(t);this.latitude=t.latitude,this.longitude=t.longitude,this.accuracy=t.accuracy,this.distance=function(t){var i=Math.PI/180,n=this.latitude-t.latitude,e=this.longitude-t.longitude,r=Math.pow(Math.sin(i*n/2),2)+Math.cos(i*this.latitude)*Math.cos(i*t.latitude)*Math.pow(Math.sin(i*e/2),2);return 12756274*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))},this.distanceAccuracy=function(t){return this.accuracy+t.accurracy}},Position=function(t){if(!(this instanceof Position))return new Position(t);this.timestamp=t.timestamp,this.coords=new Coordinates(t.coords),this.distance=function(t){return this.coords.distance(t.coords)},this.distanceAccuracy=function(t){return this.coords.distanceAccuracy(t.coords)},this.speed=function(t){return this.distance(t)/Math.abs(this.timestamp-t.timestamp)},this.positionTowardAtTimestamp=function(t,i){var n=this.coords,e=t.coords,r=(i-this.timestamp)/(t.timestamp-this.timestamp),o=1-r;return new Position({timestamp:i,coords:{latitude:e.latitude*r+o*n.latitude,longitude:e.longitude*r+o*n.longitude,accuracy:e.accuracy*r+o*n.accuracy}})}},PositionArchive=function(){if(!(this instanceof PositionArchive))return new PositionArchive;var t=[],i=function(n,e,r){var o=Math.floor((e=void 0!==e?e:0)+((r=void 0!==r?r:t.length-1)-e)/2);return r-e<0||t[e].timestamp>=n.timestamp?e:t[r].timestamp<=n.timestamp?r+1:t[o].timestamp==n.timestamp?o:r-e<=1?e+1:n.timestamp>t[o].timestamp?i(n,o,r):i(n,e,o-1)};this.add=function(n){if(null!==n.timestamp){var e=i(n);return t.length>0&&e<t.length&&t[e].timestamp===n.timestamp?t[e]=n:t.length>0&&e>=t.length&&t[t.length-1].timestamp===n.timestamp?t[t.length-1]=n:t.splice(e,0,n),this}},this.push=function(i){t.push(i)},this.eraseInterval=function(n,e){for(var r=i({timestamp:n}),o=i({timestamp:e});r>0&&t[r-1].timestamp>=n;)r--;for(;o<t.length-1&&t[o].timestamp<=e;)o++;return t.splice(r,o-r+1),this},this.getByIndex=function(i){return t[i]},this.getPositionsCount=function(){return t.length},this.getArray=function(){return t},this.getByTime=function(n){var e=i({timestamp:n});return 0===e?t[0]:e>t.length-1?t[t.length-1]:t[e].timestamp===n?t[e]:t[e-1].positionTowardAtTimestamp(t[e],n)},this.extractInterval=function(n,e){var r,o,s=i({timestamp:n}),a=new PositionArchive;0===s?r=0:s>t.length-1?r=t.length-1:(t[s].timestamp===n||a.add(t[s-1].positionTowardAtTimestamp(t[s],n)),r=s),0===(s=i({timestamp:e}))?o=0:s>t.length-1?o=t.length-1:t[s].timestamp===e?o=s:(a.add(t[s-1].positionTowardAtTimestamp(t[s],e)),o=s-1);for(var c=r;c<=o;c++)a.add(t[c]);return a},this.hasPointInInterval=function(t,n){var e=i({timestamp:t}),r=i({timestamp:n});return e!==r},this.getDuration=function(){return t.length<=1?0:t[t.length-1].timestamp-t[0].timestamp},this.getAge=function(i){return(i=null===i?+new Date:i,0===t.length)?0:i-t[0].timestamp},this.distanceUntil=function(i){var n=0;if(0===this.getPositionsCount())return 0;for(var e=this.extractInterval(t[0].timestamp,+i),r=e.getPositionsCount(),o=0;o<r-1;o++)n+=e.getByIndex(o).distance(e.getByIndex(o+1));return n}};PositionArchive.fromEncoded=function(t){for(var i,n=[],e=[1262304e3,0,0],r=t.length,o=new PositionArchive,s=!0,a=0;a<r;){for(var c=0;c<3;c++){0===c?s?(s=!1,i=intValCodec.decodeSignedValueFromString(t,a)):i=intValCodec.decodeUnsignedValueFromString(t,a):i=intValCodec.decodeSignedValueFromString(t,a),a+=i[1];var u=e[c]+i[0];n[c]=u,e[c]=u}o.push(new Position({timestamp:1e3*n[0],coords:{latitude:n[1]/1e5,longitude:n[2]/1e5,accuracy:0}})),r=t.length}return o};
