L.ImageTransform=L.ImageOverlay.extend({initialize:function(t,i,e){L.ImageOverlay.prototype.initialize.call(this,t,i,e),this.setAnchors(i)},setAnchors:function(t){this._anchors=[],this._bounds=L.latLngBounds(t);for(var i=0,e=t.length;i<e;i++){var n=t[i];this._anchors.push(L.latLng(n))}this._map&&this._reset()},_latLngToLayerPoint:function(t){return this._map.project(t)._subtract(this._map.getPixelOrigin())},setClip:function(t){var i=this._latLngToLayerPoint(this._bounds.getNorthWest()),e=[];this.options.clip=t;for(var n=0;n<t.length;n++){var o=this._latLngToLayerPoint(t[n]),s=L.ImageTransform.Utils.project(this._matrix3dInverse,o.x-i.x,o.y-i.y);e.push(L.point(s[0],s[1]))}this.setClipPixels(e)},setClipPixels:function(t){this._clipDone=!1,this._pixelClipPoints=t,this._drawCanvas()},setUrl:function(t){this._url=t,this._imgNode.src=this._url},getAnchors:function(){return this._anchors},getClip:function(){return this.options.clip},_imgLoaded:!1,_initImage:function(){this._image=L.DomUtil.create("div","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._imgNode=L.DomUtil.create("img","gmxImageTransform"),this.options.clip?(this._canvas=L.DomUtil.create("canvas","leaflet-canvas-transform"),this._image.appendChild(this._canvas),this._canvas.style[L.DomUtil.TRANSFORM_ORIGIN]="0 0",this._clipDone=!1):(this._image.appendChild(this._imgNode),this._imgNode.style[L.DomUtil.TRANSFORM_ORIGIN]="0 0",this._imgNode.style.display="none");var t=this._canvas||this._imgNode;L.DomEvent.on(t,"contextmenu",L.DomEvent.stopPropagation).on(t,"contextmenu",L.DomEvent.preventDefault).on(t,"contextmenu",function(t){var i={originalEvent:t,latlng:this._map.mouseEventToLatLng(t),layerPoint:this._map.mouseEventToLayerPoint(t),containerPoint:this._map.mouseEventToContainerPoint(t)};this.fire("contextmenu",i)},this),this._updateOpacity(),this._imgLoaded=!1,L.extend(this._imgNode,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),onerror:L.bind(this._onImageError,this),src:this._url})},_onImageError:function(){this.fire("error")},_onImageLoad:function(){this.options.clip?(this._canvas.width=this._imgNode.width,this._canvas.height=this._imgNode.height):this._imgNode.style.display="inherit",this._imgLoaded=!0,this._reset(),this.fire("load")},_reset:function(){if(!this.options.clip||this._imgLoaded){var t,i,e,n=this._image,o=this.options.clip?this._canvas:this._imgNode,s=this._latLngToLayerPoint(this._bounds.getNorthWest()),a=this._latLngToLayerPoint(this._bounds.getSouthEast())._subtract(s),r=this._anchors,h=o.width,l=o.height,m=[];for(t=0,i=r.length;t<i;t++)e=this._latLngToLayerPoint(r[t]),m.push(L.point(e.x-s.x,e.y-s.y));L.DomUtil.setPosition(n,s),n.style.width=a.x+"px",n.style.height=a.y+"px";var g=this._matrix3d=L.ImageTransform.Utils.general2DProjection(0,0,m[0].x,m[0].y,h,0,m[1].x,m[1].y,h,l,m[2].x,m[2].y,0,l,m[3].x,m[3].y);if(g[8]){for(t=0;9!==t;++t)g[t]=g[t]/g[8];if(this._matrix3dInverse=L.ImageTransform.Utils.adj(g),o.style[L.DomUtil.TRANSFORM]=this._getMatrix3dCSS(this._matrix3d),this.options.clip){if(this._pixelClipPoints){for(e=0,this.options.clip=[];e<this._pixelClipPoints.length;e++){var p=L.ImageTransform.Utils.project(g,this._pixelClipPoints[e].x,this._pixelClipPoints[e].y);this.options.clip.push(this._map.layerPointToLatLng(L.point(p[0]+s.x,p[1]+s.y)))}this._drawCanvas()}else this.setClip(this.options.clip)}}}},_getMatrix3dCSS:function(t){var i="matrix3d(";return i+=t[0].toFixed(9)+","+t[3].toFixed(9)+", 0,"+t[6].toFixed(9),i+=","+t[1].toFixed(9)+","+t[4].toFixed(9)+", 0,"+t[7].toFixed(9),i+=",0, 0, 1, 0",i+=","+t[2].toFixed(9)+","+t[5].toFixed(9)+", 0, "+t[8].toFixed(9)+")"},_clipDone:!1,_drawCanvas:function(){if(!this._clipDone&&this._imgNode){var t=this._canvas,i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.fillStyle=i.createPattern(this._imgNode,"no-repeat"),i.beginPath();for(var e=0,n=this._pixelClipPoints.length;e<n;e++){var o=this._pixelClipPoints[e];i[e?"lineTo":"moveTo"](o.x,o.y)}i.closePath(),i.fill(),i.fillStyle=null,this.options.disableSetClip&&(this._imgNode=null),this._clipDone=!0}}}),L.imageTransform=function(t,i,e){return new L.ImageTransform(t,i,e)},L.ImageTransform.addInitHook(function(){L.Mixin.ContextMenu&&L.ImageTransform.include(L.Mixin.ContextMenu)}),L.DomUtil.TRANSFORM_ORIGIN=L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin",]),function(){function t(t){return[t[4]*t[8]-t[5]*t[7],t[2]*t[7]-t[1]*t[8],t[1]*t[5]-t[2]*t[4],t[5]*t[6]-t[3]*t[8],t[0]*t[8]-t[2]*t[6],t[2]*t[3]-t[0]*t[5],t[3]*t[7]-t[4]*t[6],t[1]*t[6]-t[0]*t[7],t[0]*t[4]-t[1]*t[3],]}function i(t,i){for(var e=Array(9),n=0;3!==n;++n)for(var o=0;3!==o;++o){for(var s=0,a=0;3!==a;++a)s+=t[3*n+a]*i[3*a+o];e[3*n+o]=s}return e}function e(t,i){return[t[0]*i[0]+t[1]*i[1]+t[2]*i[2],t[3]*i[0]+t[4]*i[1]+t[5]*i[2],t[6]*i[0]+t[7]*i[1]+t[8]*i[2],]}function n(n,o,s,a,r,h,l,m){var g=[n,s,r,o,a,h,1,1,1],p=e(t(g),[l,m,1]);return i(g,[p[0],0,0,0,p[1],0,0,0,p[2]])}L.ImageTransform.Utils={general2DProjection:function(e,o,s,a,r,h,l,m,g,p,c,d,f,u,x,$){var v=n(e,o,r,h,g,p,f,u),y=n(s,a,l,m,c,d,x,$);return i(y,t(v))},project:function(t,i,n){var o=e(t,[i,n,1]);return[o[0]/o[2],o[1]/o[2]]},adj:t}}();
